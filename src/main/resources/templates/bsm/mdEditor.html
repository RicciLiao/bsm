<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>

    <meta charset="UTF-8">
    <title></title>

    <link href="../bsm/html/import.html" rel="import" type="text/html"/>

    <!--import CSS-->
    <link type="text/css" rel="stylesheet" href="../markdown/css/editormd.css">

    <!--import JavaScript-->
    <script type="text/javascript" src="../markdown/editormd.js"></script>

    <style>

        .editorContainer {
            margin: 0 auto;
            min-height: 800px;
        }

        .editorTitle {
            border-bottom: 1px solid #dddddd;
        }

        .editorTitle #mdTitle {
            font-weight: bold;
        }

        .input-group .input-group-prepend button, .input-group input {
            border-radius: 0;
            border-bottom: 0;
        }

        .input-group .input-group-prepend button .icon-save {
            padding-right: 0.4rem;
        }

        .editorTitleParent {
            width: 100%;
            padding: 0 !important;
        }

        .editormd-toolbar-container {
            padding: 0 !important;
        }

        .editormd {
            border-top: none !important;
            margin-bottom: 0 !important;
        }

        .editormd-toolbar-container .editormd-menu .glyphicon {
            top: 3px;
            color: #666;
        }

    </style>

</head>
<body>
<div id="alertInfo" th:replace="bsm/alertPage :: #alertPage"></div>

<div class="container-fluid">
    <div class="col-1"></div>
    <div id="layout" class="editorContainer col-10">
        <div id="mdEditor">
            <textarea></textarea>
        </div>
    </div>
    <div class="col-1"></div>
</div>

<script type="text/javascript" th:inline="javascript">
    $(function () {
        var editor;

        editor = editormd("mdEditor", {
            placeholder: '本编辑器支持Markdown编辑，左边编写，右边预览',
            width: "100%",
            height: $(window).height() - 5,
            syncScrolling: "single",
            path: "../markdown/lib/",
            emoji: true,
            imageUpload: true,
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL: BEU_Md_UpLoadImg,
            toolbarIcons: ["mdTitle", "undo", "redo", "|",
                "bold", "del", "italic", "quote", "ucwords", "uppercase", "lowercase", "|",
                "h1", "h2", "h3", "h4", "h5", "h6", "|",
                "list-ul", "list-ol", "hr", "|",
                "link", "reference-link", "image", "code", "preformatted-text", "code-block", "table", "datetime", "emoji", "html-entities", "pagebreak", "|",
                "goto-line", "watch", "preview", "fullscreen", "clear", "search", "|", "mdImport", "mdExport", "testIcon"], //, "|","help", "info"
            toolbarCustomIcons: {
                mdTitle: "<div class='input-group editorTitle'>" +
                "<div class='input-group-prepend'>" +
                "<button type='button' class='btn btn-primary'></button></div>" +
                "<input id='mdTitle' type='text' class='form-control'/>  " +
                "<div class='input-group-prepend'>  " +
                "<button type='button' class='btn btn-danger' id='mdEditorSave'>" +
                "<span class=' icon-save'></span>" +
                "<span></span>" +
                "</button></div></div>",
                mdImport: "<a href='javascript:;'><i class='glyphicon glyphicon-import'></i></a>",
                mdExport: "<a href='javascript:;'><i class='glyphicon glyphicon-export'></i></a>"
            },
            onload: function () {
                var mdTitle = [[${mdTitle}]] || '',
                    mdContent = [[${mdContent}]] || '',
                    mdGuid = [[${mdGuid}]] || '';

                if (mdGuid.length !== 0) {
                    editor.setMarkdown(mdContent);
                    $('.editorTitle #mdTitle').val(mdTitle);
                    $(".editorTitle button[id='mdEditorSave']").removeClass('btn-danger').addClass('btn-success');
                }

                $(".editorTitle").parent().addClass("editorTitleParent");
                $(".editorTitle button[class='btn btn-primary']").text([[#{bsm-blog-title}]]);
                $(".editorTitle button[id='mdEditorSave'] span:eq(1)").text([[#{bsm-save}]]);
                $(".editorTitle input[id='mdTitle']").attr("placeholder", [[#{bsm-blog-title-placeholder}]]);

                $(".editorContainer i[class='glyphicon glyphicon-import']").attr("title", [[#{bsm-import}]]);
                $(".editorContainer i[class='glyphicon glyphicon-export']").attr("title", [[#{bsm-export}]]);

                var editorToolbar = $('.editormd-toolbar').outerHeight();

                $(".CodeMirror").css("margin-top", editorToolbar);
                $(".editormd-preview").css("top", editorToolbar);

                $('#mdEditorSave').on({
                    click: function () {
                        mdEditorSave(editor);
                    }
                });

                $('#mdTitle').on({
                    input: function () {
                        $(".editorTitle button[id='mdEditorSave']").removeClass('btn-success').addClass('btn-danger');
                    }
                });

                $('#mdEditor textarea').on({
                    input: function () {
                        $(".editorTitle button[id='mdEditorSave']").removeClass('btn-success').addClass('btn-danger');
                    }
                });

                $(".editorContainer i[class='glyphicon glyphicon-import']").on({
                    click: function () {
                        console.log('import');
                    }
                });

                $(".editorContainer i[class='glyphicon glyphicon-export']").on({
                    click: function () {
                        console.log('export');
                    }
                });
            }
        });

        $(window).on({
            resize: function () {
                if ($(this).height() > 800) {
                    $('#mdEditor').height($(window).height() - 5);
                }
            }
        });

        //commonFunc.loadProperties();
    });

    function mdEditorSave(editor) {
        $(".action-info strong").text([[#{bsm-save-ing}]]);
        commonFunc.showTopInfo(0);

        var mdContent = editor.getMarkdown(),
            mdTitle = $('.editorTitle #mdTitle').val(),
            mdGuid = [[${mdGuid}]] || '',
            params = {
                mdTitle: mdTitle,
                mdContent: mdContent,
                mdGuid: mdGuid
            };

        $.ajax({
            type: _AJAX_TYPE,
            url: BEU_Md_Save,
            data: JSON.stringify(params),
            dataType: _AJAX_DATA_TYPE,
            contentType: _AJAX_CONTENT_TYPE,
            success: function (response) {
                $('.action-info img').hide(0);
                var timeout = 0;
                if (response.result !== _ERROR) {
                    $(".action-info").removeClass("alert-info").addClass("alert-success");
                    $(".action-info span[class='action-ico']").addClass("icon-ok-sign");
                    $(".action-info strong").text([[#{bsm-save-success}]]);
                    timeout = 2000;
                } else {

                }
                commonFunc.showTopInfo(timeout);
            },
            error: function (response) {
                console.log(response);
            }
        });
    }

</script>
</body>
</html>